<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/@webpixels/css@1.1.5/dist/index.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.4.0/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/crud.css">

</head>

<body>

  <main class="py-6 bg-surface-secondary">
    <div class="container-fluid">

      <div class="card shadow border-0 mb-7">
        <div class="card-header">
          <div><a href="/orders/admin_dashboard">Home</a></div>

          <div class="search">
            <label>
              <input type="text" placeholder="Search here" class="search" id="search" onkeyup="searching()" />

              <ion-icon name="search-outline"></ion-icon>
            </label>
          </div>

          <div class="user"></div>

          <div class="header">
            <h5 class="mb-0">Users</h5>

            <button id="add_user_btn" onclick="return addUserBtn()">Add User</button>
          </div>


        </div>
        <div class="table-responsive">


          <table class="table table-hover table-nowrap">
            <thead class="thead-light">
              <input type="text" class="number" id="number" value="1" hidden>
              <tr>
                <th scope="col" id="name" onclick="sorting(this.id)">User Name</th>
                <th scope="col" id="email" onclick="sorting(this.id)">Email</th>
                <th scope="col">Role</th>
                <th scope="col">Delete</th>
                <th scope="col">Edit</th>

              </tr>
            </thead>
            <tbody id="change">
              <% for(var i=0;i<users.length;i++) {%>

                <tr>
                  <td>
                    <a class="text-heading font-semibold" href="#">
                      <%= users[i].name %>
                    </a>
                  </td>
                  <td>
                    <%= users[i].email %>

                  </td>
                  <td>
                    <a class="text-heading font-semibold" href="#">
                      <%= users[i].role.name %>

                    </a>
                  </td>

                  <td><button onclick="confirmation(`<%= users[i].id %>`)" id="deleteBtn">Delete</button></td>

                  <td><button id="updateBtn" onclick="updateUser(`<%= users[i].id %>`)">Edit</button></td>

                </tr>
                <% } %>

            </tbody>
          </table>
        </div>

        <div class="card-footer border-0 py-5">
          <span class="text-muted text-sm">Showing 10 items out of 250 results found</span>
        </div>


        <div class="model-container-products row" id="updateuser" style="visibility: hidden;">
          <div class="col-md-12">
            <form action="" method="">

              <fieldset>

                <label for="name">User Name</label>
                <input type="text" id="updateName" name="name">

                <label for="email">Email</label>
                <input type="email" id="updateEmail" name="email">


                <select name="roleId" id="updateRole">
                  <option value="1">User</option>
                  <option value="2">Admin</option>
                </select><br><br><br>


                <button type="submit" id="updateUserBtn" onclick="return refreshPage()">Update User</button>

            </form>
          </div>
        </div>

      </div>
      <div class="center">
        <div class="pagination">
          <%for(var i=1; i<=lastPage; i++) { %>

            <span class="page" id="<%=i%>" onclick="pagination('<%=i%>')">
              <%=i%>
            </span>
            <% } %>

        </div>
      </div>

    </div>
    </div>



  </main>

</body>

<script>

  async function pagination(page) {
    console.log(page);
    var set = '';

    await axios.post(`/users/page?page=${page}`).then(function (response) {
      console.log("", response.data);
      console.log("l", response.data.length);

      for (var i = 0; i < response.data.length; i++) {
        // set += `<tr><td>${response.data[i].name}</td><td>${response.data[i].email}</td><td>${response.data[i].role.name}</td><td class="text-end"><button type="button" id="editbutton" class="login-trigger btn btn-sm btn-neutral" data-target="#login" data-toggle="modal" onclick="return editUser('${response.data[i].id}')">Edit</button><button type="button" class="btn btn-sm btn-square btn-neutral text-danger-hover" onclick=" userdelete('${response.data[i].id}')"><i class="bi bi-trash"></i></button></td></tr>`

        set += `<tr>
                  <td>
                    <a class="text-heading font-semibold" href="#">
                      ${response.data[i].name}
                    </a>
                  </td>
                  <td>
                    ${response.data[i].email}

                  </td>
                  <td>
                    <a class="text-heading font-semibold" href="#">
                      ${response.data[i].role.name}

                    </a>
                  </td>

                  <td><button onclick="confirmation('${response.data[i].id}')" id="deleteBtn">Delete</button></td>

                  <td><button id="updateBtn" onclick="updateUser('${response.data[i].id}')">Edit</button></td>

                </tr>`


      }
      console.log(set);
      document.getElementById("change").innerHTML = set;

    });
  }



  async function searching() {

    var val = document.getElementById("search").value
    console.log(val);
    var set = '';
    await axios.get(`/auth/search?data=${val}`).then(function (response) {
      console.log("datt ===", response.data);


      for (var i = 0; i < response.data.length; i++) {
        // set += `<tr><td>${response.data[i].name}</td><td>${response.data[i].email}</td><td>${response.data[i].role.name}</td><td class="text-end"><button type="button" id="editbutton" class="login-trigger btn btn-sm btn-neutral" data-target="#login" data-toggle="modal" onclick="return editUser('${response.data[i].id}')">Edit</button><button type="button" class="btn btn-sm btn-square btn-neutral text-danger-hover" onclick=" userdelete('${response.data[i].id}')"><i class="bi bi-trash"></i></button></td></tr>`

        set += `<tr>
                  <td>
                    <a class="text-heading font-semibold" href="#">
                      ${response.data[i].name}
                    </a>
                  </td>
                  <td>
                    ${response.data[i].email}

                  </td>
                  <td>
                    <a class="text-heading font-semibold" href="#">
                      ${response.data[i].role.name}

                    </a>
                  </td>

                  <td><button onclick="confirmation(' ${response.data[i].id}')" id="deleteBtn">Delete</button></td>

                  <td><button id="updateBtn" onclick="updateUser(' ${response.data[i].id}')">Edit</button></td>

                </tr>`

      }
      console.log(set);
      document.getElementById("change").innerHTML = set;
    });

  }


  async function sorting(sort) {
    console.log(sort);
    var set = '';
    number = document.getElementById("number").value;
    console.log(number);
    if (number % 2 == 0) {
      var plus = ++number;
      document.getElementById("number").value = plus;
      console.log("plus", plus);
      console.log("if", number % 2 == 0);
      var sort_type = 'desc';
      await axios.post(`/users/sort-user?data=${sort}&type=${sort_type}`).then(function (response) {
        console.log(response);

        for (var i = 0; i < response.data.length; i++) {


          set += `<tr>
                  <td>
                    <a class="text-heading font-semibold" href="#">
                      ${response.data[i].name}
                    </a>
                  </td>
                  <td>
                    ${response.data[i].email}

                  </td>
                  <td>
                    <a class="text-heading font-semibold" href="#">
                      ${response.data[i].role.name}

                    </a>
                  </td>

                  <td><button onclick="confirmation(' ${response.data[i].id}')" id="deleteBtn">Delete</button></td>

                  <td><button id="updateBtn" onclick="updateUser(' ${response.data[i].id}')">Edit</button></td>

                </tr>`


        }
        console.log(set);
        document.getElementById("change").innerHTML = set;
      });

    } else {
      var plus = ++number;
      console.log("plus", plus);
      document.getElementById("number").value = plus;


      console.log("else", number % 2 == 0);
      var sort_type = 'asc';
      await axios.post(`/users/sort-user?data=${sort}&type=${sort_type}`).then(function (response) {
        console.log(response);

        for (var i = 0; i < response.data.length; i++) {

          set += `<tr>
                  <td>
                    <a class="text-heading font-semibold" href="#">
                      ${response.data[i].name}
                    </a>
                  </td>
                  <td>
                    ${response.data[i].email}

                  </td>
                  <td>
                    <a class="text-heading font-semibold" href="#">
                      ${response.data[i].role.name}

                    </a>
                  </td>

                  <td><button onclick="confirmation(' ${response.data[i].id}')" id="deleteBtn">Delete</button></td>

                  <td><button id="updateBtn" onclick="updateUser(' ${response.data[i].id}')">Edit</button></td>

                </tr>`


        }
        console.log(set);
        document.getElementById("change").innerHTML = set;
      });

    }

  }





  function sortData() {

  }


  async function searchUser() {
    var searchValue = document.getElementById('search').value;
    console.log(searchValue);

    await axios.get(`/users/search?search=${searchValue}`);
  }

  function addUserBtn() {
    window.location.assign('/users/add_user_page')
    // window.location.reload()

  }

  const updateUser = async (id) => {


    var modal1 = document.getElementById("updateuser");
    modal1.style.visibility = "visible";

    const res = await axios.get(`/users/user/${id}`);
    console.log("res");
    const user = res.data;
    console.log("user res", res);
    console.log(user);
    document.getElementById('updateName').value = user.name;
    document.getElementById('updateEmail').value = user.email;
    document.getElementById('updateRole').value = user.roleId;

    const updateForm = document.querySelector('#updateuser');
    updateForm.addEventListener('submit', async (e) => {
      e.preventDefault()
      const res1 = await axios.put(`/users/${id}`, {

        name: document.getElementById('updateName').value,
        email: document.getElementById('updateEmail').value,
        roleId: document.getElementById('updateRole').value,
      })
      // modal1.style.visibility = "hidden"; 
      document.querySelector('.model-container').style.visibility = "hidden";

      // location.assign('/users/user')
      // window.location.reload();

      console.log(res1);
    })

  }
  function refreshPage() {
    window.location.assign('http://localhost:3000/users/user')
    window.location.assign('http://localhost:3000/users/user')

    // window.location.reload();
    // window.location.reload();

  }
  async function confirmation(id) {
    if (confirm("Are you sure you want to delete this data..?")) {


      axios.delete(`/users/${id}`).then(function (response) { return "data deleted" })

      window.location.reload()


    } else {
      alert("not deleted");
    }
  }



</script>


</html>