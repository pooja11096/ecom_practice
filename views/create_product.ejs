<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="/adminStyle.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/@webpixels/css@1.1.5/dist/index.css">

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.4.0/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="/css/crud.css">


</head>

<body>

    <main class="py-6 bg-surface-secondary">
        <div class="container-fluid">

            <div class="card shadow border-0 mb-7">
                <div class="card-header">
                    <div><a href="/orders/admin_dashboard">Home</a></div>

                    <div class="search">
                        <label>
                            <input type="text" placeholder="Search here" class="search" id="search"
                                onkeyup="searching()" />

                            <ion-icon name="search-outline"></ion-icon>
                        </label>
                    </div>

                    <div class="user"></div>
                    <div class="header">
                        <h5 class="mb-0">Products</h5>


                        <button id="addProducts" onclick="addProductPage()">Add Products</button>
                    </div>

                </div>
                <div class="table-responsive">


                    <table class="table table-hover table-nowrap">
                        <thead class="thead-light">
                            <input type="text" class="number" id="number" value="1" hidden>


                            <tr>
                                <th scope="col" id="product_name" onclick="sorting(this.id)">Product Name</th>
                                <th scope="col" id="product_description" onclick="sorting(this.id)">Description</th>
                                <th scope="col" id="product_price" onclick="sorting(this.id)">Price</th>
                                <th scope="col">Categories</th>
                                <th scope="col">Delete</th>
                                <th scope="col">Edit</th>

                            </tr>

                        </thead>
                        <tbody id="tbody">

                            <% for(var i=0;i<products.length;i++) {%>

                                <!-- <tr>/home/pooja-makwana/Pictures/final_ecom/uploads -->
                                <!-- <%=products[i].image_url%> -->
                                <td>
                                    <img src="/<%=products[i].image_url%>" class="avatar avatar-sm rounded-circle me-2">
                                    <a class="text-heading font-semibold" href="#">
                                        <%= products[i].product_name %>
                                    </a>
                                </td>
                                <td>
                                    <%= products[i].product_description %>

                                </td>
                                <td>
                                    <a class="text-heading font-semibold" href="#">
                                        <%= products[i].product_price %>

                                    </a>
                                </td>
                                <td>
                                    <ul>
                                        <% for (let j=0; j< products[i].categories.length; j++) { %>

                                            <li>
                                                <%= products[i].categories[j].category_name %>

                                            </li>
                                            <% } %>
                                    </ul>
                                </td>


                                <td> <span onclick="deleteProduct(`<%= products[i].id %>`)"> Delete</span></td>

                                <td><button id="updateProduct"
                                        onclick="editProduct(`<%= products[i].id %>`)">Edit</button>
                                </td>



                                </tr>
                                <% } %>

                        </tbody>
                    </table>
                </div>

                <div class="card-footer border-0 py-5">
                    <!-- <span class="text-muted text-sm">Showing 10 items out of 250 results found</span> -->
                </div>


                <div class="model-container-products" id="updateuser" style="visibility: hidden;">
                    <div class="col-md-12">
                        <div class="model">
                            <div
                                onclick="document.querySelector('.model-container-products').style.visibility = 'hidden'">
                                <i class="fa fa-window-close" aria-hidden="true"></i>
                            </div>

                            <form id="addProductForm" enctype="multipart/form-data" action="/data" method="get">

                                <fieldset>

                                    <label for="name">Product Name</label>
                                    <input type="text" id="product_name" name="product_name">

                                    <label for="product_description">Product description</label>
                                    <input type="text" id="product_description" name="product_description">

                                    <label for="product_price">Product price</label>
                                    <input type="text" id="product_price" name="product_price">

                                    <label for="image_url">Select Image</label>
                                    <input type="file" name="image_url" id="image_url">

                                    <label for="categories">Select category</label>
                                    <select id="categoriesDropDown" name="categoriesDropDown" multiple>
                                    </select>


                                    <input type="submit" name="submit" value="Add">

                                    <!-- <button type="submit" id="updateUserBtn" onclick="return refreshPage()">Update User</button> -->

                            </form>
                        </div>
                    </div>
                </div>



                <div class="model-container" id="updateuser" style="visibility: hidden;">
                    <div class="col-md-12">
                        <div class="model">
                            <div onclick="document.querySelector('.model-container').style.visibility = 'hidden'">
                                <i class="fa fa-window-close" aria-hidden="true"></i>
                            </div>

                            <form id="updateForm" enctype="multipart/form-data">

                                <fieldset>

                                    <label for="name">Product Name</label>
                                    <input type="text" id="uproduct_name" name="product_name">

                                    <label for="product_description">Product description</label>
                                    <input type="text" id="uproduct_description" name="product_description">

                                    <label for="product_price">Product price</label>
                                    <input type="text" id="uproduct_price" name="product_price">

                                    <!-- <label for="image_url">Select Image</label>
                                    <input type="file" name="image_url" id="file"> -->

                                    <label for="categories">Select Category</label>
                                    <select id="catDropDown" name="catDropDown" multiple>
                                    </select>

                                    <input type="submit" name="submit" value="Add">


                            </form>
                        </div>
                    </div>
                </div>

            </div>

            <div class="center">
                <div class="pagination">
                    <%for(var i=1; i <=lastPage; i++) { %>

                        <span class="page" id="<%=i%>" onclick="pagination('<%=i%>')">
                            <%=i%>
                        </span>
                        <% } %>

                </div>
            </div>


        </div>
        </div>

    </main>


</body>
<script>

    window.onload = () => {
        getCategories()
    }

    async function getCategories() {

        const categoriesData = await axios.get('/categories/cats');
        console.log("categoriesData", categoriesData)

        for (let catagory of categoriesData.data) {

            let option = document.createElement("option");
            option.setAttribute('value', catagory.id);

            let optionText = document.createTextNode(catagory.category_name);
            option.appendChild(optionText);

            let option1 = document.createElement("option");
            option1.setAttribute('value', catagory.id);

            let optionText1 = document.createTextNode(catagory.category_name);
            option1.appendChild(optionText1);

            catDropDown.appendChild(option);
            categoriesDropDown.appendChild(option1);
        }
    }


    const add = document.querySelector('#addProducts');
    add.addEventListener('click', () => {
        document.querySelector('.model-container-products').style.visibility = 'visible';
    })

    const form = document.querySelector('#addProductForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        let name = document.getElementById("product_name").value;
        let description = document.getElementById("product_description").value;
        let price = Number(document.getElementById("product_price").value);


        let catagory = document.getElementById("categoriesDropDown").value;
        let categoryIds = catagory;
        let formData = new FormData(form);

        let res = await axios.post('/products/createproduct', formData)
        document.querySelector('.model-container-products').style.visibility = 'hidden';

        document.getElementById("product_name").value = '';
        document.getElementById("product_description").value = '';
        document.getElementById("product_price").value = '';
        // document.getElementById("file").value = '';
        getProducts();
    })

    // const editProduct = async (id) => {
    async function editProduct(id) {
        // e.preventDefault();
        // const res = await axios.get(`/products/product/edit/${id}`);
        const res = await axios.get(`/products/product/edit/${id}`);

        const user = res.data;


        // document.getElementById('uid').value = user.id;
        document.getElementById('uproduct_name').value = user.product_name;
        document.getElementById('uproduct_description').value = user.product_description;
        document.getElementById('uproduct_price').value = user.product_price;
        // document.getElementById('catDropDown').value = user.categories[0].id;


        var category = [];
        for (var i = 0; i < user.categories.length; i++) {
            // category += user.categories[i].id
            category.push(user.categories[i].id);
        }

        document.getElementById('catDropDown').value = category;

        document.querySelector('.model-container').style.visibility = 'visible';


        const form = document.querySelector('#updateForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            var selected = [];
            for (var option of document.getElementById('catDropDown').options) {
                if (option.selected) {
                    selected.push(option.value);
                }
            }



            const product_n = document.getElementById("uproduct_name").value;
            const product_description = document.getElementById("uproduct_description").value;
            const product_price = document.getElementById("uproduct_price").value;

            const catagory = document.getElementById("catDropDown").value;

            const formData = new FormData(form);
            const formDataObj = Object.fromEntries(formData.entries());



            const res = await axios.put(`/products/update/${id}`,
                {
                    product_name: document.getElementById('uproduct_name').value,
                    product_description: document.getElementById('uproduct_description').value,
                    product_price: parseInt(document.getElementById('uproduct_price').value),
                    catDropDown: selected
                });
            document.querySelector('.model-container').style.visibility = 'hidden';
            // getProducts();
            location.reload();

        })
    }


    async function deleteProduct(id) {
        let res = await axios.delete(`/products/${id}`);
        getProducts();
    }

    async function searching() {

        var val = document.getElementById("search").value
        var set = '';
        await axios.post(`/products/search-product?data=${val}`).then(function (response) {


            for (var i = 0; i < response.data.length; i++) {

                let category = '';

                for (var j = 0; j < response.data[i].categories.length; j++) {
                    category += response.data[i].categories[j].category_name + '&nbsp&nbsp';
                }

                set += `
                <tr>
                    <td>
                    <img src="/${response.data[i].image_url}" alt="" class="avatar avatar-sm rounded-circle me-2">
                    
                    ${response.data[i].product_name}</td>
                    <td>${response.data[i].product_description}</td>
                    <td>${response.data[i].product_price}</td>
                    <td>
                    <ul>
                            <li>
                                ${category}
                                
                            </li>
                            
                            
                    </ul>
                    </td>
                    <td><button onclick="deleteProduct(' ${response.data[i].id}')">delete</button></td>
                    <td><button onclick="editProduct(' ${response.data[i].id}')">edit</button></td>
                </tr>
                `
            }
            document.getElementById("tbody").innerHTML = set;
        });

    }

    async function pagination(page) {
        var set = '';

        await axios.post(`/products/page?page=${page}`).then(function (response) {
            for (var i = 0; i < response.data.length; i++) {
                let category = '';

                for (var j = 0; j < response.data[i].categories.length; j++) {
                    category += response.data[i].categories[j].category_name + '&nbsp&nbsp';
                }

                set += `
                <tr>
                    <td>
                        <img src="/${response.data[i].image_url}" alt="" class="avatar avatar-sm rounded-circle me-2">
                    
                    ${response.data[i].product_name}</td>
                    <td>${response.data[i].product_description}</td>
                    <td>${response.data[i].product_price}</td>
                    <td>
                    <ul>
                            <li>
                                ${category}
                                
                            </li>
                            
                            
                    </ul>
                    </td>
                    <td><button onclick="deleteProduct('${response.data[i].id}')">delete</button></td>
                    <td><button onclick="editProduct('${response.data[i].id}')">edit</button></td>
                </tr>
                `

            }
            document.getElementById("tbody").innerHTML = set;

        });
    }




    async function sorting(sort) {
        var set = '';
        number = document.getElementById("number").value;
        if (number % 2 == 0) {
            var plus = ++number;
            document.getElementById("number").value = plus;

            var sort_type = 'desc';
            await axios.post(`/products/sort-product?data=${sort}&type=${sort_type}`).then(function (response) {

                for (var i = 0; i < response.data.length; i++) {

                    let category = '';

                    for (var j = 0; j < response.data[i].categories.length; j++) {
                        category += response.data[i].categories[j].category_name + '&nbsp&nbsp';
                    }
                    set += `
                <tr>
                    <td>
                        <img src="/${response.data[i].image_url}" alt="" class="avatar avatar-sm rounded-circle me-2">
                    
                    ${response.data[i].product_name}</td>
                    <td>${response.data[i].product_description}</td>
                    <td>${response.data[i].product_price}</td>
                    <td>
                    <ul>
                            <li>
                                ${category}
                                
                            </li>
                            
                            
                    </ul>
                    </td>
                    <td><button onclick="deleteProduct(' ${response.data[i].id}')">delete</button></td>
                    <td><button onclick="editProduct(' ${response.data[i].id}')">edit</button></td>
                </tr>
                `


                }
                document.getElementById("tbody").innerHTML = set;
            });

        } else {
            var plus = ++number;
            document.getElementById("number").value = plus;


            var sort_type = 'asc';
            await axios.post(`/products/sort-product?data=${sort}&type=${sort_type}`).then(function (response) {

                for (var i = 0; i < response.data.length; i++) {

                    let category = '';

                    for (var j = 0; j < response.data[i].categories.length; j++) {
                        category += response.data[i].categories[j].category_name + '&nbsp&nbsp';
                    }

                    set += `
                <tr>
                    <td>
                    <img src="/${response.data[i].image_url}" alt="" class="avatar avatar-sm rounded-circle me-2">

                    ${response.data[i].product_name}</td>
                    <td>${response.data[i].product_description}</td>
                    <td>${response.data[i].product_price}</td>
                    <td>
                    <ul>
                            <li>
                                ${category}
                                
                            </li>
                            
                            
                    </ul>
                    </td>
                    <td><button onclick="deleteProduct(' ${response.data[i].id}')">delete</button></td>
                    <td><button onclick="editProduct(' ${response.data[i].id}')">edit</button></td>
                </tr>
                `


                }
                document.getElementById("tbody").innerHTML = set;
            });

        }

    }


</script>

</html>